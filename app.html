<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeFlow - Real Code Analysis Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .auth-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: transform 0.2s;
        }
        
        .button:hover {
            transform: translateY(-2px);
        }
        
        .input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .results {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .hidden {
            display: none;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç CodeFlow - Real Code Analysis Platform</h1>
            <p>Advanced code analysis with AI-powered insights using Supabase & Vercel</p>
        </div>

        <div id="auth-section" class="auth-section">
            <h2>Authentication</h2>
            <div id="login-form">
                <input type="email" id="email" class="input" placeholder="Email">
                <input type="password" id="password" class="input" placeholder="Password">
                <input type="text" id="name" class="input" placeholder="Name (for registration)" style="display: none;">
                <button id="login-btn" class="button">Login</button>
                <button id="register-btn" class="button">Register</button>
                <button id="show-register" class="button" style="background: #6c757d;">Switch to Register</button>
            </div>
            <div id="user-info" class="hidden">
                <p>Welcome, <span id="user-name"></span>!</p>
                <button id="logout-btn" class="button" style="background: #dc3545;">Logout</button>
            </div>
        </div>

        <div id="main-app" class="main-content hidden">
            <h2>üöÄ Real Code Analysis</h2>
            
            <div class="grid">
                <div class="card">
                    <h3>üìä Code Analysis</h3>
                    <textarea id="code-input" class="textarea" placeholder="Paste your code here for analysis..."></textarea>
                    <select id="language-select" class="input">
                        <option value="javascript">JavaScript</option>
                        <option value="python">Python</option>
                        <option value="java">Java</option>
                        <option value="typescript">TypeScript</option>
                        <option value="php">PHP</option>
                        <option value="go">Go</option>
                    </select>
                    <select id="analysis-type" class="input">
                        <option value="full">Full Analysis</option>
                        <option value="complexity">Complexity Only</option>
                        <option value="security">Security Only</option>
                    </select>
                    <button id="analyze-btn" class="button">üîç Analyze Code</button>
                </div>
                
                <div class="card">
                    <h3>ü§ñ AI Assistant</h3>
                    <select id="ai-provider" class="input">
                        <option value="openai">OpenAI (GPT-4)</option>
                        <option value="anthropic">Anthropic (Claude)</option>
                        <option value="google">Google (Gemini)</option>
                    </select>
                    <input type="text" id="ai-message" class="input" placeholder="Ask about your code...">
                    <button id="ai-ask-btn" class="button">ü§ñ Ask AI</button>
                </div>
            </div>

            <div id="results-section" class="results hidden"></div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.origin;
        let currentUser = null;
        let authToken = null;

        // DOM Elements
        const authSection = document.getElementById('auth-section');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const userInfo = document.getElementById('user-info');
        const resultsSection = document.getElementById('results-section');

        // Check for existing auth token
        const token = localStorage.getItem('codeflow_token');
        if (token) {
            authToken = token;
            showMainApp();
        }

        // Auth event listeners
        document.getElementById('login-btn').addEventListener('click', () => authenticate('login'));
        document.getElementById('register-btn').addEventListener('click', () => authenticate('register'));
        document.getElementById('logout-btn').addEventListener('click', logout);
        document.getElementById('show-register').addEventListener('click', toggleRegisterForm);

        // App event listeners
        document.getElementById('analyze-btn').addEventListener('click', analyzeCode);
        document.getElementById('ai-ask-btn').addEventListener('click', askAI);

        function toggleRegisterForm() {
            const nameField = document.getElementById('name');
            const showRegisterBtn = document.getElementById('show-register');
            
            if (nameField.style.display === 'none') {
                nameField.style.display = 'block';
                showRegisterBtn.textContent = 'Switch to Login';
            } else {
                nameField.style.display = 'none';
                showRegisterBtn.textContent = 'Switch to Register';
            }
        }

        async function authenticate(action) {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const name = document.getElementById('name').value;

            if (!email || !password) {
                alert('Please fill in all fields');
                return;
            }

            if (action === 'register' && !name) {
                alert('Please enter your name');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/auth`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action,
                        email,
                        password,
                        name
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('codeflow_token', authToken);
                    showMainApp();
                } else {
                    alert(data.error || 'Authentication failed');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('codeflow_token');
            showAuthSection();
        }

        function showMainApp() {
            authSection.classList.add('hidden');
            mainApp.classList.remove('hidden');
            if (currentUser) {
                document.getElementById('user-name').textContent = currentUser.name || currentUser.email;
            }
            loginForm.classList.add('hidden');
            userInfo.classList.remove('hidden');
        }

        function showAuthSection() {
            authSection.classList.remove('hidden');
            mainApp.classList.add('hidden');
            loginForm.classList.remove('hidden');
            userInfo.classList.add('hidden');
        }

        async function analyzeCode() {
            const code = document.getElementById('code-input').value;
            const language = document.getElementById('language-select').value;
            const analysisType = document.getElementById('analysis-type').value;

            if (!code.trim()) {
                alert('Please enter some code to analyze');
                return;
            }

            try {
                showResults('üîÑ Analyzing code...');
                
                const response = await fetch(`${API_BASE}/api/analysis`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        code,
                        language,
                        analysisType
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    displayAnalysisResults(data.analysis);
                } else {
                    showResults('‚ùå Error: ' + (data.error || 'Analysis failed'));
                }
            } catch (error) {
                showResults('‚ùå Error: ' + error.message);
            }
        }

        async function askAI() {
            const message = document.getElementById('ai-message').value;
            const provider = document.getElementById('ai-provider').value;

            if (!message.trim()) {
                alert('Please enter a question');
                return;
            }

            try {
                showResults('ü§ñ AI is thinking...');

                // First create a session
                const sessionResponse = await fetch(`${API_BASE}/api/ai`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        action: 'create-session',
                        provider: provider
                    })
                });

                const sessionData = await sessionResponse.json();
                
                if (!sessionResponse.ok) {
                    throw new Error(sessionData.error);
                }

                // Send message
                const messageResponse = await fetch(`${API_BASE}/api/ai`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        action: 'send-message',
                        sessionId: sessionData.session.id,
                        message: message,
                        context: document.getElementById('code-input').value
                    })
                });

                const messageData = await messageResponse.json();

                if (messageResponse.ok) {
                    showResults(`ü§ñ AI Response:\n\n${messageData.response}\n\nüí∞ Tokens used: ${messageData.tokensUsed || 'N/A'}\nüí≤ Cost: $${messageData.cost || '0.00'}`);
                    document.getElementById('ai-message').value = '';
                } else {
                    showResults('‚ùå AI Error: ' + (messageData.error || 'AI request failed'));
                }
            } catch (error) {
                showResults('‚ùå Error: ' + error.message);
            }
        }

        function displayAnalysisResults(analysis) {
            let output = 'üìä Code Analysis Results:\n\n';
            
            if (analysis.complexity) {
                output += `üî¢ Complexity Score: ${analysis.complexity.score || 'N/A'}\n`;
                output += `üìà Cyclomatic Complexity: ${analysis.complexity.cyclomatic || 'N/A'}\n`;
            }
            
            if (analysis.security) {
                output += `\nüîí Security Analysis:\n`;
                output += `Overall Security Score: ${analysis.security.score || 'N/A'}/100\n`;
                
                if (analysis.security.vulnerabilities && analysis.security.vulnerabilities.length > 0) {
                    output += `\n‚ö†Ô∏è Vulnerabilities Found:\n`;
                    analysis.security.vulnerabilities.forEach((vuln, i) => {
                        output += `${i+1}. ${vuln.type} (${vuln.severity}): ${vuln.message}\n`;
                        if (vuln.line) output += `   Line ${vuln.line}\n`;
                    });
                } else {
                    output += `‚úÖ No security issues detected\n`;
                }
            }
            
            if (analysis.functions) {
                output += `\nüîß Functions: ${analysis.functions.length}\n`;
            }
            
            if (analysis.variables) {
                output += `üìù Variables: ${analysis.variables.length}\n`;
            }
            
            if (analysis.dependencies) {
                output += `üì¶ Dependencies: ${analysis.dependencies.length}\n`;
            }

            showResults(output);
        }

        function showResults(content) {
            resultsSection.textContent = content;
            resultsSection.classList.remove('hidden');
        }

        // Test API connection on load
        fetch(`${API_BASE}/api/health`)
            .then(response => response.json())
            .then(data => {
                console.log('API Status:', data);
                if (data.status === 'ok') {
                    document.querySelector('.header p').innerHTML += ' <span class="status-indicator status-success"></span>API Connected';
                } else {
                    document.querySelector('.header p').innerHTML += ' <span class="status-indicator status-error"></span>API Issues';
                }
            })
            .catch(error => {
                console.error('API Connection Error:', error);
                document.querySelector('.header p').innerHTML += ' <span class="status-indicator status-error"></span>API Offline';
            });
    </script>
</body>
</html>